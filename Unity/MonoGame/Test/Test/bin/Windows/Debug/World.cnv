module AsteroidShooter

open @"C:\Users\Francesco\Documents\GitHub\casanova-mk2\Unity\MonoGame\Test\Test\bin\Windows\Debug\MonoGame.Framework.dll"
open Microsoft.Xna.Framework
open Microsoft.Xna.Framework.Input
open System
open KeyboardManager

worldEntity World = {
  Ship                          : Ship
  Asteroids                     : [Asteroid]
  State                         : KeyboardState
  Input                         : KeyboardInput
  RandomGenerator               : Random

  rule State = Keyboard.GetState()
  rule Input.OldState, Input.CurrentState = Input.CurrentState, Input.OldState

  rule Asteroids =
    //let randomPos = new Vector2(-300.0f + (float RandomGenerator.NextDouble() * 600.0f), -50.0f)
    //let randomWait = 2.0f + (float RandomGenerator.NextDouble() * 3.0f)
    yield (new Asteroid(new Vector2(250.0f, -50.0f))) :: Asteroids
    wait 3.0f

  rule Asteroids =
    [for a in Asteroids do
     where (a.Position.Y < 1500.0f)
     select (a)]

  rule Asteroids =
    [for a in Asteroids do
     let projs =
        [for p in Ship.Projectiles do
         where (Vector2.Distance(a.Position, p.Position) < 50)
         select (p)]
     where (projs.Count = 0)
     select (a)]

  Create() =
    {
      Ship                  = new Ship()
      Asteroids             = []
      State                 = Keyboard.GetState()
      Input                 = new KeyboardInput()
      RandomGenerator       = new Random()
    }
}

entity Ship = {
  Position    : Vector2
  Projectiles : [Projectile]

  rule Position =
    let vy = new Vector2(-300.0f, 0.0f)
    wait world.State.IsKeyDown(Keys.A)
    yield Position + vy * dt

  rule Position =
    let vy = new Vector2(300.0f, 0.0f)
    wait world.State.IsKeyDown(Keys.D)
    yield Position + vy * dt

  rule Projectiles =
    [for p in Projectiles do
     where (p.Position.Y > -50.0f)
     select (p)]

  rule Projectiles =
    wait KeyboardInput.GetKeyPressed(world.Input, Keys.Q)
    yield (new Projectile(Position)) :: Projectiles
    

  Create() =
    {
      Position = new Vector2(750.0f, 1000.0f)
      Projectiles = []
    }

}

entity Projectile = {
  Position    : Vector2

  rule Position = Position + (new Vector2(0.0f, -500.0f)) * dt

  Create(p : Vector2) =
    {
      Position = p
    }
}

entity Asteroid = {

  Position      : Vector2

  rule Position = Position + (new Vector2(0.0f, 250.0f)) * dt

  Create(p : Vector2) =
    {
      Position = p
    }
}
